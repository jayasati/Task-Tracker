datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Task {
  id       String   @id @default(cuid())
  title    String
  type     String   @default("task")
  habitType String   @default("") // "" | time | amount | both
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs     TimeLog[]
  statuses   TaskStatus[]
  timerSessions TimerSession[]
  
  // User association - links task to Clerk user
  userId   String   @default("") // Clerk user ID
  
  // New fields for enhanced task tracking
  repeatMode String   @default("none") // none, daily, weekly, monthly, custom
  weekdays   Int[]    // 0-6 for Sun-Sat, used when repeatMode is custom or weekly
  startDate  DateTime?
  endDate    DateTime?
  priority   String   @default("medium") // low, medium, high
  category   String   @default("task") // task, make_habit, break_habit, professional
  amount     String?  // "10 reps", "2 liters"
  estimate   Int?     // in minutes
  requiredMinutes Int? @default(0) // daily required minutes for time/both habits
  requiredAmount  Int? @default(0) // daily required amount for amount/both habits
  subtasks   String[]
  notes      String?
  
  // Completion and archive tracking
  isCompleted  Boolean   @default(false)
  completedAt  DateTime?
  isArchived   Boolean   @default(false)
  
  // Progress tracking (0-4 level system)
  progressLevel Int      @default(0) // 0=not attempted, 1=gray, 2=50%, 3=70%, 4=100%
  
  // Multi-select and timer tracking
  isSelected    Boolean   @default(false) // For multi-select delete
  lastResetDate DateTime? // Last 2AM reset timestamp
  
  @@index([isArchived])
  @@index([category])
  @@index([userId])
}

model TimeLog {
  id        String   @id @default(cuid())
  seconds   Int      @default(0)
  date      DateTime
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  @@unique([taskId, date])
  @@index([date])
  @@index([taskId])
}

model TaskStatus {
  id        String   @id @default(cuid())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  date      DateTime
  status    Status   @default(NONE)

  // Subtask tracking
  completedSubtasks String[]  @default([])
  dailySubtasks     String[]  @default([]) // Snapshot of subtasks for that day

  // Daily progress tracking (0-4 level system)
  progressLevel Int @default(0) // 0=not attempted, 1=25%, 2=50%, 3=75%, 4=100%

  @@unique([taskId, date])
  @@index([date])
  @@index([taskId])
}

model TimerSession {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  startTime DateTime
  endTime   DateTime?
  date      DateTime // The day this session belongs to (based on 2AM cutoff)
  seconds   Int      @default(0) // Calculated duration when stopped
  isActive  Boolean  @default(true) // Whether timer is currently running
  
  @@index([taskId])
  @@index([date])
  @@index([isActive])
}

enum Status {
  NONE
  FAIL
  HALF
  SUCCESS
}

